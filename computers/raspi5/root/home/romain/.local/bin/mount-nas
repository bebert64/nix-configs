#!/bin/bash
set -euo pipefail

# Add script directory to PATH to find unmount-nas
export PATH="/home/romain/.local/bin:$PATH"

NAS_IP="192.168.1.3"
NAS_IP_AND_VOLUME="${NAS_IP}:/volume1/NAS"
NAS_MOUNT_POINT="/mnt/NAS"
NAS_NAME="NasLaFouillouse"
NAS_PORT="5000"

mkdir -p ${NAS_MOUNT_POINT}

if [[ $(ls ${NAS_MOUNT_POINT}) ]]; then
  echo "NAS seems to already be mounted"
  exit
fi

if ! ping -c1 ${NAS_IP} &> /dev/null; then
  echo "No machine responding at ${NAS_IP}"
  unmount-nas
  exit
fi

if [[ $(curl -s ${NAS_IP}:${NAS_PORT} | grep ${NAS_NAME}) ]]; then
  mount ${NAS_IP_AND_VOLUME} ${NAS_MOUNT_POINT}
  echo "mounted ${NAS_NAME} successfully"
else
  echo "The machine at ${NAS_IP} seems to not be ${NAS_NAME}"
  unmount-nas
fi
